<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Meeting – View (Fixed)</title>
<style>
  :root{ --bg:#f6f8fb; --card:#ffffff; --ink:#243048; --muted:#667085; --line:#e6ebf2; --accent:#0F2D56; --ok:#0b62ff; --pill:#eef4ff; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .grid{display:grid;grid-template-columns:2fr 1.2fr;gap:18px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 0 rgba(16,24,40,.02)}
  .media{padding:10px}
  .media .imgwrap{position:relative;border-radius:12px;overflow:hidden}
  .media img{width:100%;display:block}
  .img-edit{position:absolute;right:10px;top:10px;background:#ffffffea;border:1px solid #dbe4f0;border-radius:10px;padding:8px;cursor:pointer}
  .img-edit svg{display:block}
  .content{padding:14px 16px 18px}
  .title{font-size:28px;line-height:1.25;margin:4px 0 8px 0}
  .meta{color:#556581;font-size:14px}
  .meta strong{color:#1d2741}
  .desc{margin-top:10px;color:#3b4863}
  .more{color:#0b62ff;text-decoration:underline;cursor:pointer}

  /* Right column tabs (Video/Chat) */
  .tabs{display:flex;gap:26px;padding:14px 16px;border-bottom:1px solid var(--line)}
  .tab{position:relative;padding:8px 4px;font-weight:700;color:#0c1a34;opacity:.9;cursor:pointer}
  .tab.active::after{content:"";position:absolute;left:0;right:0;bottom:-14px;height:3px;border-radius:2px;background:var(--accent)}
  .panel{padding:18px;min-height:220px;display:flex;align-items:center;justify-content:center;color:#6b7790}

  /* Agenda */
  .section-head{display:flex;align-items:center;justify-content:space-between;margin:22px 0 12px}
  .section-title{font-size:28px}
  .end-btn{background:#0b62ff;border:1px solid #0b62ff;color:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .end-btn.disabled{background:#e9edf5;border-color:#e9edf5;color:#98a2b3;cursor:not-allowed}
  .agenda-card{padding:14px}
  .agenda-list{display:flex;flex-direction:column;gap:12px}
  .agenda-item{border:1px solid #e7edf5;border-radius:12px;padding:14px;display:grid;grid-template-columns:auto 1fr auto;gap:12px}
  .agenda-item.dragging{opacity:.65}
  .handle{display:grid;place-items:center;width:28px;cursor:grab}
  .item-title{font-weight:700}
  .item-meta{color:#667085;font-size:14px;margin-top:2px}
  .item-desc{margin-top:8px;color:#2b3856}
  .item-actions{display:flex;gap:8px;align-items:start}
  .icon-btn{background:transparent;border:1px solid #e7edf5;border-radius:10px;padding:8px;cursor:pointer}
  .icon-btn:hover{background:#f6f9fe}

  /* attachments row */
  .attach-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
  .pill{border:1px solid #cfe0ff;background:var(--pill);color:#0b3b91;border-radius:999px;padding:6px 10px;font-weight:600;font-size:13px;cursor:pointer}
  .attach-link{color:#0b62ff;text-decoration:underline;cursor:pointer;font-size:13px}

  /* Picker Modal (forms/docs) */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,20,40,.45);z-index:40;padding:20px}
  .modal.open{display:flex}
  .dialog{width:min(1040px,96vw);max-height:84vh;background:#fff;border:1px solid #dfe5f0;border-radius:14px;box-shadow:0 14px 60px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden}
  .dragbar{cursor:move;user-select:none;background:#f8fafc;border-bottom:1px solid #eef2f7;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .close-x{background:#fff;border:1px solid #e6ebf2;border-radius:8px;padding:6px 10px;cursor:pointer}
  .modal-body{padding:16px;overflow:auto}
  .modal-actions{display:flex;justify-content:flex-end;gap:10px;padding:12px;border-top:1px solid #eef2f7}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #e0e6f2;background:#fff;font-weight:700;cursor:pointer}
  .btn.primary{background:#0b62ff;border-color:#0b62ff;color:#fff}
  .field{margin-bottom:12px}
  label{display:block;font-size:14px;color:#1f2a44;margin-bottom:6px;font-weight:700}
  .input, select{width:100%;height:44px;border:1px solid #e7edf5;border-radius:8px;padding:0 12px;font-size:15px;color:#0f1f3a;background:#fff;outline:none}
  .upload-box{border:2px dashed #cfe0ff;background:#f8fbff;border-radius:12px;padding:18px;text-align:center;cursor:pointer}
  .upload-box input{display:none}

  /* Custom dropdown (multi-select) */
  .ms{position:relative}
  .ms-toggle{display:flex;align-items:center;justify-content:space-between;border:1px solid #e2e8f0;border-radius:8px;padding:10px 12px;height:44px;background:#fff;cursor:pointer}
  .ms-values{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .ms-placeholder{color:#97a3b6}
  .ms-pill{border:1px solid #e7edf5;border-radius:999px;padding:2px 8px;font-size:12px;background:#f8fafc}
  .ms-menu{position:absolute;z-index:30;left:0;right:0;top:calc(100% + 6px);background:#fff;border:1px solid #e7edf5;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.08);max-height:260px;overflow:auto;display:none}
  .ms.open .ms-menu{display:block}
  .ms-option{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid #f2f5fa}
  .ms-option:last-child{border-bottom:0}

  /* Floating windows (viewing forms/docs) – NO dark background */
  .floatwin{position:fixed;left:80px;top:80px;width:min(900px,96vw);max-height:84vh;background:#fff;border:1px solid #dfe5f0;border-radius:14px;box-shadow:0 14px 60px rgba(0,0,0,.25);display:flex;flex-direction:column;z-index:60}
  .floatwin .dragbar{cursor:move}
  .floatwin .modal-body{padding:16px;overflow:auto}

  /* Confirm dialog for delete */
  .confirm{position:fixed;inset:0;background:rgba(10,20,40,.45);display:none;align-items:center;justify-content:center;z-index:50}
  .confirm.open{display:flex}
  .confirm .box{background:#fff;border:1px solid #e6ebf2;border-radius:14px;max-width:520px;width:92vw;padding:18px}
  .confirm .q{font-size:18px;text-align:center;margin:8px 0 14px}
  .confirm .actions{display:flex;justify-content:center;gap:10px}
  .btn.dark{background:#0F2D56;color:#fff;border-color:#0F2D56}

  /* End-of-Meeting Drawer (REVISED) */
  .eom-wrap{position:fixed;inset:0;display:none;z-index:70}
  .eom-wrap.open{display:block}
  .eom-scrim{position:absolute;inset:0;background:rgba(10,20,40,.25)}
  .eom{position:absolute;right:0;top:0;height:100%;width:min(820px,95vw);background:#fff;border-left:1px solid var(--line);box-shadow:-10px 0 40px rgba(0,0,0,.18);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .25s}
  .eom.open{transform:translateX(0)}
  .eom-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
  .eom-tabs{display:flex;gap:22px}
  .eom-tabs .tab{padding:8px 6px;font-weight:800;cursor:pointer}
  .eom-tabs .tab.active{color:#0F2D56;position:relative}
  .eom-tabs .tab.active::after{content:"";position:absolute;left:0;right:0;bottom:-10px;height:3px;background:#0F2D56;border-radius:3px}
  .eom-body{padding:14px 16px;overflow:auto}
  .eom-footer{display:flex;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid var(--line)}

  /* chips reused */
  .chip{border:1px solid #d8e2f2;background:#f5f8ff;border-radius:999px;padding:4px 8px;font-size:12px;cursor:pointer}
  .chip.selected{background:#0b62ff;border-color:#0b62ff;color:#fff}

  /* RTE-like editor boxes (for Summary/Next Steps) */
  .rte{border:1px solid #e6ebf2;border-radius:10px;overflow:hidden;background:#fff}
  .rte-toolbar{display:flex;gap:10px;align-items:center;padding:8px 10px;border-bottom:1px solid #eef2f7;background:#fbfcfe}
  .rte-toolbar .btn{padding:6px 8px;border-radius:8px;font-weight:600}
  .rte-area{min-height:200px;padding:12px;outline:none}
  .rte-area:empty:before{content:attr(data-placeholder);color:#9aa4b6}

  /* List adders (Decisions / Questions / Issues) */
  .list-add .input{height:40px}
  .list-items{margin-top:8px;padding-left:18px}
  .list-items li{margin:6px 0}
  .list-items li .rm{margin-left:8px;color:#9aa4b6;cursor:pointer}

  /* Existing Journeys preview */
  .journey-pills{display:flex;gap:10px;flex-wrap:wrap}
  .journey-pill{border:1px solid #e6ebf2;background:#fafcff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
  .journey-pill.active{background:#eef4ff;border-color:#cfe0ff;color:#0b3b91}
  .journey-preview{margin-top:12px;border:1px solid #e8eef7;border-radius:10px;overflow:hidden}
  .phase{border-bottom:1px solid #eef2f7;background:#fff}
  .phase:last-child{border-bottom:0}
  .phase-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;font-weight:700}
  .phase-h .status{font-weight:600;color:#6a7690}
  .phase-b{display:none;padding:12px 14px;color:#425170}
  .phase.open .phase-b{display:block}

  /* Follow-Up Summary (added earlier) */
  .fus-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line)}
  .fus-title{font-size:20px;font-weight:800}
  .fus-meta{display:flex;gap:14px;align-items:center;color:#4b5a78}
  .fus-body{padding:14px 16px;display:grid;grid-template-columns:1.2fr 1fr;gap:18px}
  @media (max-width:900px){ .fus-body{grid-template-columns:1fr} }
  .fus-section{border:1px dashed #e9eef7;border-radius:10px;padding:12px}
  .fus-section h4{margin:0 0 10px 0;font-size:14px;text-transform:uppercase;letter-spacing:.02em;color:#44506b}
  .fus-tags{display:flex;gap:8px;flex-wrap:wrap}
  .fus-list{margin:0;padding-left:18px;color:#2b3856}
  .fus-row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:start;margin-top:8px}
  .fus-note{padding:10px 16px;border-top:1px solid var(--line);font-size:12px;color:#6b7790}

  /* ===== Attendee Tasks (new) ===== */
  .att-card .panel{padding:16px;display:block;min-height:0;color:inherit;justify-content:flex-start;align-items:stretch}
  .task-list{display:flex;flex-direction:column;gap:12px}
  .task-item{border:1px solid #e7edf5;border-radius:12px;padding:12px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .task-title{font-weight:700}
  .task-meta{color:#667085;font-size:14px;margin-top:2px}
  .task-actions{display:flex;gap:8px;align-items:center}
  .kebab{border:1px solid #e7edf5;border-radius:8px;background:#fff;cursor:pointer;padding:6px}
  .menu{position:relative}
  .menu-flyout{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid #e7edf5;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.08);display:none;min-width:180px;z-index:35}
  .menu.open .menu-flyout{display:block}
  .menu-item{display:flex;gap:8px;align-items:center;padding:10px 12px;border-bottom:1px solid #f2f5fa;cursor:pointer}
  .menu-item:last-child{border-bottom:0}
  .menu-item:hover{background:#f8fafc}
  /* Narrower task modal than global dialog */
  #taskModal .dialog{width:min(900px,96vw);max-height:86vh}

  /* Tag-style multi-select (reusing base .ms styles) */
  .ms-option[data-value]{cursor:pointer}
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <!-- Left column -->
      <div class="card">
        <div class="media">
          <div class="imgwrap">
            <img src="https://d34hmiuaex7c0.cloudfront.net/2952/uploads/form_value_featured_1754429911120.png" alt="Featured meeting image"/>
            <button class="img-edit" title="Edit image" aria-label="Edit image">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0F2D56" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
            </button>
          </div>
        </div>
        <div class="content">
          <div class="title">Vladimir - Segwik Initial Walk Through</div>
          <div class="meta">Meeting Type: <strong>Segwik Initial Walk Through</strong></div>
          <div class="meta" style="margin-top:6px;">Aug 15, 2025 &nbsp; 2:15pm – 2:20pm &nbsp; , America/Mexico_City</div>
          <div class="meta" style="margin-top:6px;">Virtual : <a href="#">https://zoom.us/j/23178803322?pwd=5Qnk965DRd7wfSgUK5FX0gc2gxuqW.1</a><br/>Meeting ID: 231 788 03322 &nbsp; Passcode: 5Ra0SR</div>
          <div class="desc">A quick, personalized walkthrough of Segwik to help new users get oriented, answer questions, and schedule a 30-day check-in for ongoing support. <span class="more" id="moreBtn">more</span></div>
        </div>
      </div>

      <!-- Right column -->
      <div class="card" id="rcard">
        <div class="tabs" id="rcardTabs">
          <div class="tab active" data-tab="video">Video</div>
          <div class="tab" data-tab="chat">Chat</div>
        </div>
        <div class="panel" id="videoPanel">Coming Soon..</div>
        <div class="panel" id="chatPanel" style="display:none">Coming Soon..</div>
      </div>
    </div>
    <!-- Follow-Up Summary heading outside the card -->
<div class="section-head" id="followUpHead" style="margin-top:28px; display:none">
  <div class="section-title">Follow-Up Summary</div>
</div>
    <!-- Follow-Up Summary card (hidden until Smart Tasks run) -->
    <div id="followUpCard" class="card" style="display:none; margin-bottom:12px">
      <div class="fus-head" style="justify-content:flex-start; gap:12px">
        <div class="fus-meta">
          <span class="chip"><strong>Contact:</strong> <span id="fuContact">Vladimir</span></span>
          <span class="chip selected"><strong>Status:</strong> <span id="fuStatus">Attended</span></span>
        </div>
      </div>
      <div class="fus-body">
        <div class="fus-section">
          <h4>Journeys Selected</h4>
          <div id="fuJourneys" class="fus-tags"></div>
        </div>
        <div class="fus-section">
          <h4>Smart Tasks Queued</h4>
          <ol id="fuTasks" class="fus-list"></ol>
          <div class="fus-row">
            <div class="muted">Queued</div>
            <div id="fuQueuedTime">Just now</div>
          </div>
          <div class="fus-row">
            <div class="muted">Applies To</div>
            <div id="fuApplies">Vladimir</div>
          </div>
        </div>
      </div>
      <div class="fus-note">The journeys have been triggered, and the smart tasks are now in queue.</div> 
    </div>
    <!-- ===== Attendee Tasks (inserted) ===== -->
    <div class="section-head" style="margin-top:28px">
      <div class="section-title">Attendee Tasks</div>
      <div>
        <button id="addTaskBtn" class="btn primary">Add Task</button>
      </div>
    </div>
    <div class="card att-card">
      <div class="tabs" id="attTabs">
        <div class="tab active" data-tab="pre">Pre-Meeting</div>
        <div class="tab" data-tab="post">Post-Meeting</div>
      </div>
      <div class="panel" id="prePanel">
        <div id="preList" class="task-list"></div>
      </div>
      <div class="panel" id="postPanel" style="display:none">
        <div id="postList" class="task-list"></div>
      </div>
    </div>
    <!-- ===== End Attendee Tasks ===== -->

    <!-- Follow-Up Summary heading outside the card -->
<div class="section-head" id="followUpHead" style="margin-top:28px; display:none">
  <div class="section-title">Follow-Up Summary</div>
</div>
    <!-- Follow-Up Summary card (hidden until Smart Tasks run) -->
    <div id="followUpCard" class="card" style="display:none; margin-bottom:12px">
      <div class="fus-head" style="justify-content:flex-start; gap:12px">
        <div class="fus-meta">
          <span class="chip"><strong>Contact:</strong> <span id="fuContact">Vladimir</span></span>
          <span class="chip selected"><strong>Status:</strong> <span id="fuStatus">Attended</span></span>
        </div>
      </div>
      <div class="fus-body">
        <div class="fus-section">
          <h4>Journeys Selected</h4>
          <div id="fuJourneys" class="fus-tags"></div>
        </div>
        <div class="fus-section">
          <h4>Smart Tasks Queued</h4>
          <ol id="fuTasks" class="fus-list"></ol>
          <div class="fus-row">
            <div class="muted">Queued</div>
            <div id="fuQueuedTime">Just now</div>
          </div>
          <div class="fus-row">
            <div class="muted">Applies To</div>
            <div id="fuApplies">Vladimir</div>
          </div>
        </div>
      </div>
      <div class="fus-note">The journeys have been triggered, and the smart tasks are now in queue.</div> 
    </div>

    <div class="section-head">
      <div class="section-title">Agenda</div>
      <div>
        <button id="endBtn" class="end-btn">End Meeting</button>
      </div>
    </div>
    <div class="card agenda-card">
      <div class="agenda-list" id="agendaList"></div>
    </div>
  </div>

  <!-- Picker Modal (forms/docs) -->
  <div class="modal" id="modal">
    <div class="dialog" id="dialog">
      <div class="dragbar" id="dragbar"><h4 id="modalTitle">Modal</h4><button class="close-x" id="closeModal">✕</button></div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions"><button class="btn" id="cancelBtn">Cancel</button><button class="btn primary" id="saveBtn">Add</button></div>
    </div>
  </div>

  <!-- Confirm Remove Modal -->
  <div class="confirm" id="confirmModal">
    <div class="box">
      <div style="display:flex;justify-content:flex-end"><button class="icon-btn" id="confirmClose" aria-label="Close">✖</button></div>
      <div class="q">Are you sure you want to remove agenda?</div>
      <div class="actions">
        <button class="btn dark" id="confirmYes">YES</button>
        <button class="btn" id="confirmNo">NO</button>
      </div>
    </div>
  </div>

  <!-- Add Task Modal (Attendee Tasks) -->
  <div class="modal" id="taskModal">
    <div class="dialog" id="taskDialog">
      <div class="dragbar"><h4 style="margin:0">Add Task</h4><button class="close-x" id="taskClose">✕</button></div>
      <div class="modal-body">
        <div class="field"><label>Task Name</label><input id="tName" class="input" placeholder="e.g., Fill Out Form"/></div>
        <div class="row">
          <div class="field"><label>Task Type</label>
            <select id="tType">
              <option value="" disabled selected>Select Task Type</option>
              <option>User</option>
              <option>Contact</option>
            </select>
          </div>
          <div class="field"><label>Action</label>
            <select id="tAction">
              <option value="" disabled selected>Select Action</option>
              <option>Send Email</option>
              <option>Send Text</option>
              <option>Fill in Contact Fields</option>
              <option>Fill Out Form</option>
              <option>Watch Video</option>
              <option>Read Article</option>
            </select>
          </div>
        </div>
        <div id="tExtras"></div>
        <div class="field"><label>Short Description</label><input id="tShort" class="input" placeholder="Optional short description"/></div>
        <div class="field"><label>Long Description</label><textarea id="tLong" class="input" placeholder="Optional details..."></textarea></div>
      </div>
      <div class="modal-actions"><button class="btn" id="taskCancel">Cancel</button><button class="btn primary" id="taskSave">Add Task</button></div>
    </div>
  </div>

  <!-- Remove Confirm (Attendee Tasks) -->
  <div class="confirm" id="removeConfirm">
    <div class="box">
      <div style="display:flex;justify-content:flex-end"><button class="btn" id="remClose" aria-label="Close">✖</button></div>
      <div class="q">Are you sure you want to remove this task?</div>
      <div class="actions">
        <button class="btn dark" id="remYes">YES</button>
        <button class="btn" id="remNo">NO</button>
      </div>
    </div>
  </div>

  <!-- End-of-Meeting Drawer (REVISED MARKUP) -->
  <div class="eom-wrap" id="eomWrap">
    <div class="eom-scrim" id="eomScrim"></div>
    <aside class="eom" id="eom">
      <div class="eom-head">
        <div class="eom-tabs" id="eomTabs">
          <div class="tab active" data-tab="summary">End of Meeting Summary</div>
          <div class="tab" data-tab="automation">Automation</div>
        </div>
        <button class="close-x" id="eomClose">✕</button>
      </div>
      <div class="eom-body" id="eomBody"></div>
      <div class="eom-footer">
        <button class="btn" id="eomNextBtn">Next</button>
        <button class="btn primary" id="submitEndBtn" style="display:none">Submit and End Meeting</button>
      </div>
    </aside>
  </div>

<script>
  /* ===== Right-column tabs (scoped to #rcard) ===== */
  document.querySelectorAll('#rcardTabs .tab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('#rcardTabs .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const showVideo = t.dataset.tab==='video';
    document.getElementById('videoPanel').style.display = showVideo?'flex':'none';
    document.getElementById('chatPanel').style.display = showVideo?'flex':'none';
  }));
  document.getElementById('moreBtn').addEventListener('click', (e)=>{
    e.currentTarget.parentElement.textContent = 'A quick, personalized walkthrough of Segwik to help new users get oriented, answer questions, and schedule a 30-day check-in for ongoing support.';
  });

  // Catalogs
  const FORM_OPTIONS = ['Segwik Initial Walkthrough Form','Onboarding Checklist','Post-Meeting Feedback','Discovery Questionnaire','Budget Intake Form','Security Review Form','Requirements Capture','Change Request Form'];
  const DOC_OPTIONS = ['Segwik Quick Pitch Guide','Segwik Pricing & Plan Snapshot','Segwik Journeys Overview','Segwik Features'];
  const JOURNEYS = [
    'Referral Partner Journey',
    'Solopreneur Journey',
    'Small Business Journey',
    'Owner Journey',
    'Small Business Employee Journey',
    'Sales Team Journey',
    'Enterprise Journey',
    'Not Interested Journey',
    'Nurturing Journey'
  ];
  const SMART_TASK_OPTIONS = [
    'Modify Contact Details',
    'Forward Contact To Pete for Follow-Up',
    'Create a Project',
    'Log Note'
  ];
  const CONTACT_FIELD_OPTIONS = [
    'Tags','Contact Type','Business Goals','Industry','Job Title','Persona','General Info','Birthday','Website','Calendar Booker Url'
  ];
  const MEETING_STATUSES=['Attended','Rescheduled','Cancelled','No Show'];

  // Agenda data
  const agendaData = [
    {title:'Review Pre-Meeting Form', dur:3, desc:'Confirm whether the pre-meeting form was completed and, if so, review responses to gain initial context before proceeding.', forms:[], docs:[]},
    {title:'Discovery & Profiling Questions', dur:12, desc:'Ask all key qualification and profiling questions in one sequence to determine if the contact is most likely to buy, give referrals, or express interest for the future.', forms:['Segwik Initial Walkthrough Form'], docs:[]},
    {title:'Product Demo', dur:8, desc:'Give a concise demonstration of Segwik’s most relevant features tailored to the prospect’s needs.', forms:[], docs:[]},
    {title:'Package Selection & Commitment', dur:4, desc:'Present available subscription options, confirm interest, and secure next steps—sign-up, schedule with Pete, or defer decision.', forms:[], docs:['Segwik Packages']},
    {title:'Referral Program Invite', dur:2, desc:'Offer the Referral Partner Program as an additional or alternative engagement path, even if they’re not ready to buy.', forms:[], docs:[]},
    {title:'Wrap-Up & Journey Selection', dur:1, desc:'Summarize agreed next steps, confirm follow-up details, and log the final Journey type for tracking.', forms:[], docs:[]}
  ];

  const agendaList = document.getElementById('agendaList');
  renderAll();

  function renderAll(){
    agendaList.innerHTML='';
    agendaData.forEach((it, idx)=> agendaList.appendChild(renderItem(it, idx)) );
  }

  function renderItem(it, idx){
    const item = document.createElement('div'); item.className = 'agenda-item'; item.dataset.idx = idx;

    const handle = document.createElement('div'); handle.className = 'handle'; handle.setAttribute('draggable','true');
    handle.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0F2D56" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="6" height="6" rx="1" fill="#0F2D56"/><rect x="14" y="4" width="6" height="6" rx="1" fill="#0F2D56"/><rect x="4" y="14" width="6" height="6" rx="1" fill="#0F2D56"/><rect x="14" y="14" width="6" height="6" rx="1" fill="#0F2D56"/></svg>`;

    const body = document.createElement('div');
    body.innerHTML = `<div class="item-title">${it.title}</div><div class="item-meta">Duration: ${it.dur} Minutes</div><div class="item-desc">${it.desc}</div>`;
    body.appendChild(renderAttachments(it, item));

    const actions = document.createElement('div'); actions.className='item-actions';
    const del = iconBtn('x'); del.title='Delete'; del.addEventListener('click', ()=> openConfirm(()=>{ const cur = parseInt(item.dataset.idx); agendaData.splice(cur,1); renderAll(); }));
    const edit = iconBtn('edit'); edit.title='Edit'; edit.addEventListener('click', ()=> openEdit(parseInt(item.dataset.idx)) );
    actions.appendChild(del); actions.appendChild(edit);

    // Drag behaviour via handle
    handle.addEventListener('dragstart', ()=>{ item.classList.add('dragging'); });
    handle.addEventListener('dragend', ()=>{ item.classList.remove('dragging'); syncOrderFromDOM(); });

    item.appendChild(handle); item.appendChild(body); item.appendChild(actions);
    return item;
  }

  agendaList.addEventListener('dragover', (e)=>{
    e.preventDefault();
    const dragging = document.querySelector('.agenda-item.dragging');
    if(!dragging) return;
    const after = getDragAfterElement(agendaList, e.clientY);
    if(after == null){ agendaList.appendChild(dragging); }
    else { agendaList.insertBefore(dragging, after); }
  });
  function getDragAfterElement(container, y){
    const elems = [...container.querySelectorAll('.agenda-item:not(.dragging)')];
    return elems.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if(offset < 0 && offset > closest.offset){ return {offset, element: child}; }
      else { return closest; }
    }, {offset: Number.NEGATIVE_INFINITY}).element;
  }
  function syncOrderFromDOM(){
    const newOrder = [];
    [...agendaList.children].forEach((node)=>{ newOrder.push(agendaData[parseInt(node.dataset.idx)]); });
    agendaData.splice(0, agendaData.length, ...newOrder);
    renderAll();
  }

  function renderAttachments(it, hostItem){
    const attach = document.createElement('div'); attach.className='attach-row';
    if(it.forms && it.forms.length){ it.forms.forEach(name=> attach.appendChild(pill(name, ()=> openFormWindow(name)))); }
    if(it.docs && it.docs.length){ it.docs.forEach(name=> attach.appendChild(pill(name, ()=> openDocWindow(name)))); }

    const af = document.createElement('a'); af.className='attach-link'; af.textContent='Attach Forms'; af.href='#';
    af.addEventListener('click', (e)=>{ e.preventDefault(); openFormsPicker(parseInt(hostItem.dataset.idx)); });
    const ad = document.createElement('a'); ad.className='attach-link'; ad.textContent='Attach Documents'; ad.href='#';
    ad.addEventListener('click', (e)=>{ e.preventDefault(); openDocsPicker(parseInt(hostItem.dataset.idx)); });
    attach.appendChild(af); attach.appendChild(ad);

    return attach;
  }

  function pill(text, onClick){ const p = document.createElement('button'); p.className='pill'; p.type='button'; p.textContent=text; p.addEventListener('click', onClick); return p; }
  function iconBtn(kind){ const b = document.createElement('button'); b.className='icon-btn'; if(kind==='x') b.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0F2D56" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'; if(kind==='edit') b.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0F2D56" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>'; return b; }

  // ------- Edit agenda -------
  function openEdit(idx){
    const it = agendaData[idx];
    const body = `
      <div class="field"><label>Title</label><input id="eTitle" class="input" value="${it.title.replaceAll('"','&quot;')}"/></div>
      <div class="field"><label>Duration (minutes)</label><input id="eDur" class="input" value="${it.dur}"/></div>
      <div class="field"><label>Description</label><textarea id="eDesc" class="input">${it.desc.replaceAll('<','&lt;')}</textarea></div>`;
    openModal('Edit Agenda', body, 'Save');
    saveBtn.onclick = ()=>{ it.title=document.getElementById('eTitle').value.trim(); it.dur=parseInt(document.getElementById('eDur').value)||it.dur; it.desc=document.getElementById('eDesc').value.trim(); closeModal(); renderAll(); };
  }

  // ------- Pickers (dropdown-style multi-select) -------
  function openFormsPicker(idx){
    const it = agendaData[idx];
    const body = `<div class="field"><label>Select form(s)</label><div id="formsMS" class="ms" data-placeholder="Choose forms"></div></div>`;
    openModal('Attach Forms', body, 'Add');
    const formsMS = createMultiSelect(document.getElementById('formsMS'), FORM_OPTIONS, new Set(it.forms));
    saveBtn.onclick = ()=>{ it.forms = Array.from(new Set([...(it.forms||[]), ...formsMS.getSelected()])); closeModal(); renderAll(); };
  }
  function openDocsPicker(idx){
    const it = agendaData[idx];
    const body = `<div class="field"><label>Select document(s)</label><div id="docsMS" class="ms" data-placeholder="Choose documents"></div></div><div class="field"><label>Upload new</label><label class="upload-box" for="docUpload">Drop files here or click to upload<input id="docUpload" type="file" multiple></label></div>`;
    openModal('Attach Documents', body, 'Add');
    const docsMS = createMultiSelect(document.getElementById('docsMS'), DOC_OPTIONS, new Set(it.docs));
    saveBtn.onclick = ()=>{ const selected = docsMS.getSelected(); const files = Array.from(document.getElementById('docUpload').files||[]).map(f=>f.name); it.docs = Array.from(new Set([...(it.docs||[]), ...selected, ...files])); closeModal(); renderAll(); };
  }

  /* Existing checkbox-style multi-select (used for Forms/Docs pickers) */
  function createMultiSelect(el, options, preselected=new Set()){
    const state = {selected: new Set(preselected)};
    const toggle = document.createElement('div'); toggle.className='ms-toggle';
    const values = document.createElement('div'); values.className='ms-values';
    const caret = document.createElement('span'); caret.textContent='▾';
    toggle.appendChild(values); toggle.appendChild(caret);
    const menu = document.createElement('div'); menu.className='ms-menu';
    options.forEach(opt=>{
      const row = document.createElement('label'); row.className='ms-option';
      const cb = document.createElement('input'); cb.type='checkbox'; cb.value=opt; cb.checked = state.selected.has(opt);
      const sp = document.createElement('span'); sp.textContent=opt;
      row.appendChild(cb); row.appendChild(sp); menu.appendChild(row);
      cb.addEventListener('change', ()=>{ if(cb.checked) state.selected.add(opt); else state.selected.delete(opt); render(); });
    });
    el.appendChild(toggle); el.appendChild(menu);
    toggle.addEventListener('click', (e)=>{ e.stopPropagation(); el.classList.toggle('open'); });
    document.addEventListener('click', ()=> el.classList.remove('open'));
    function render(){
      values.innerHTML='';
      if(state.selected.size===0){ const ph=document.createElement('span'); ph.className='ms-placeholder'; ph.textContent=el.dataset.placeholder||'Select...'; values.appendChild(ph); }
      else { state.selected.forEach(v=>{ const pill=document.createElement('span'); pill.className='ms-pill'; pill.textContent=v; values.appendChild(pill); }); }
    }
    render();
    return { getSelected: ()=> Array.from(state.selected) };
  }

  /* NEW: Tag-style multi-select WITHOUT checkboxes (for Journeys/Smart Tasks/Contact Fields) */
  function createTagMultiSelect(el, options, preselected=new Set()){
    const state = {selected: new Set(preselected)};
    const toggle = document.createElement('div'); toggle.className='ms-toggle';
    const values = document.createElement('div'); values.className='ms-values';
    const caret = document.createElement('span'); caret.textContent='▾';
    toggle.appendChild(values); toggle.appendChild(caret);
    const menu = document.createElement('div'); menu.className='ms-menu';
    options.forEach(opt=>{
      const row = document.createElement('div'); row.className='ms-option'; row.setAttribute('data-value', opt);
      const sp = document.createElement('span'); sp.textContent=opt;
      row.appendChild(sp); menu.appendChild(row);
      row.addEventListener('click', (e)=>{ e.stopPropagation(); if(state.selected.has(opt)){ state.selected.delete(opt); } else { state.selected.add(opt); } render(); });
    });
    el.appendChild(toggle); el.appendChild(menu);
    toggle.addEventListener('click', (e)=>{ e.stopPropagation(); el.classList.toggle('open'); });
    document.addEventListener('click', ()=> el.classList.remove('open'));
    function render(){
      values.innerHTML='';
      if(state.selected.size===0){ const ph=document.createElement('span'); ph.className='ms-placeholder'; ph.textContent=el.dataset.placeholder||'Select...'; values.appendChild(ph); }
      else { state.selected.forEach(v=>{ const pill=document.createElement('span'); pill.className='ms-pill'; pill.textContent=v; values.appendChild(pill); }); }
      // highlight selected in menu
      [...menu.children].forEach(ch=>{
        const val = ch.getAttribute('data-value');
        ch.style.background = state.selected.has(val) ? '#f5f8ff' : '#fff';
      });
    }
    render();
    return { getSelected: ()=> Array.from(state.selected) };
  }

  // ------- Delete confirmation -------
  const cModal = document.getElementById('confirmModal');
  const cYes = document.getElementById('confirmYes');
  const cNo = document.getElementById('confirmNo');
  const cClose = document.getElementById('confirmClose');
  function openConfirm(onYes){ cModal.classList.add('open'); cYes.onclick=()=>{ onYes(); cModal.classList.remove('open'); }; }
  [cNo,cClose].forEach(b=> b.addEventListener('click', ()=> cModal.classList.remove('open')));

  // ------- Modal plumbing (picker) -------
  const modal = document.getElementById('modal');
  const dialog = document.getElementById('dialog');
  const dragbar = document.getElementById('dragbar');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const closeModalBtn = document.getElementById('closeModal');
  const cancelBtn = document.getElementById('cancelBtn');
  const saveBtn = document.getElementById('saveBtn');
  function openModal(title, bodyHTML, saveLabel='Add'){ modalTitle.textContent = title; modalBody.innerHTML = bodyHTML; saveBtn.textContent = saveLabel; modal.classList.add('open'); }
  function closeModal(){ modal.classList.remove('open'); }
  closeModalBtn.addEventListener('click', closeModal); cancelBtn.addEventListener('click', closeModal);
  (function(){ let startX, startY, startL, startT, dragging=false; dragbar.addEventListener('mousedown', (e)=>{ dragging = true; const r = dialog.getBoundingClientRect(); startX = e.clientX; startY = e.clientY; startL = r.left; startT = r.top; document.body.style.userSelect='none'; }); window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx = e.clientX - startX; const dy = e.clientY - startY; dialog.style.position='fixed'; dialog.style.left = (startL + dx) + 'px'; dialog.style.top = (startT + dy) + 'px'; }); window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; }); })();

  // ------- Float windows (view forms/docs/video) – background NOT dark -------
  function createFloatWindow(title, bodyHTML){
    const fw = document.createElement('div'); fw.className='floatwin';
    fw.innerHTML = `<div class="dragbar"><h4 style="margin:0">${title}</h4><button class="close-x">✕</button></div><div class="modal-body">${bodyHTML}</div>`;
    document.body.appendChild(fw);
    const bar = fw.querySelector('.dragbar');
    const close = fw.querySelector('.close-x');
    close.addEventListener('click', ()=> fw.remove());
    let sx, sy, sl, st, dragging=false;
    bar.addEventListener('mousedown', (e)=>{ dragging=true; const r = fw.getBoundingClientRect(); sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top; document.body.style.userSelect='none'; });
    window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; fw.style.left=(sl+dx)+'px'; fw.style.top=(st+dy)+'px'; fw.style.position='fixed'; });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
    return fw;
  }
  function openVideoWindow(name){
    const videoSrc = 'https://www.w3schools.com/html/mov_bbb.mp4';
    const html = `
      <div style="display:grid;gap:10px">
        <video controls style="width:100%;border-radius:10px;outline:none">
          <source src="${videoSrc}" type="video/mp4"/>
          Your browser does not support the video tag.
        </video>
        <div><a href="${videoSrc}" target="_blank" rel="noopener">Open ${name} in new tab</a></div>
      </div>`;
    createFloatWindow(name, html);
  }

  // ------- Forms (radio inputs clickable) -------
  function openFormWindow(name){
    const html = `
      <form id="walkForm">
        ${rf('Confirm if pre-meeting form was completed', ['Yes - Review Form Responses','No'])}
        ${rf('Work Style', ['Solo','Organization'])}
        ${rf('Decision-making authority', ['Yes','No'])}
        ${rf('Main Priority for this Call', ['Learn about the app','Referrals / network growth','Solve networking challenges'])}
        ${rf('Networking challenges faced', ['Yes','No'])}
        ${rf('Technology Comfort Level', ['Very Comfortable','Neutral','Not Comfortable'])}
        ${rf('Segwik App Status', ['Installed and Used','Start Demo'])}
        ${rf('Interest in Segwik', ['Not Interested','Interested, Not Ready','Ready to Buy','Start Demo'])}
        ${rf('After Demo – Next Step', ['Ready to Buy','Wants to Speak with Pete','Not Interested','No Time Right Now'])}
        ${rf('Schedule Meeting with Pete', ['Done Scheduling','Will Schedule Time Later'])}
        ${rf('Choose Package', ['Solopreneur','Small Business','Enterprise'])}
        ${rf('Identify Decision Maker', ['Decision Maker Identified','Decision Maker Not Identified'])}
        <div class="field" id="dmFields" style="display:none;">
          <label>Decision Maker Details</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><input class="input" placeholder="Name"/><input class="input" placeholder="Email"/></div>
        </div>
        ${rf('Referral Program Interest', ['Interested in Referral Program','Not Interested in Referral Program'])}
      </form>
      <div style="font-size:12px;color:#6b7790;margin-top:6px;">All fields are single-choice (radio).</div>`;
    const win = createFloatWindow(name, html);
    win.addEventListener('change', (e)=>{
      if(e.target && e.target.name==='Identify Decision Maker'){
        win.querySelector('#dmFields').style.display = (e.target.value==='Decision Maker Identified') ? 'block' : 'none';
      }
    });
  }
  function rf(label, options){
    return `<fieldset class="field"><label>${label}</label>${options.map((o,i)=>`<label style=\"display:inline-flex;align-items:center;gap:6px;margin:0 10px 6px 0\"><input type=\"radio\" name=\"${label}\" value=\"${o}\" ${i===0?'checked':''}/> <span>${o}</span></label>`).join('')}</fieldset>`
  }

  // ------- Documents content -------
  function openDocWindow(name){
    let html='';
    if(name==='Segwik Quick Pitch Guide'){
      html = `<article><h2>Segwik Quick Pitch Guide (One-Minute Intro)</h2>
      <h3>What is Segwik?</h3>
      <p>Segwik is more than a CRM — it’s a Relationship Operating System that helps you track, grow, and automate every touchpoint in your business. From managing warm leads to staying connected with past clients, Segwik makes sure no relationship slips through the cracks.</p>
      <h3>Top 3 Benefits:</h3>
      <ul><li><strong>Never Miss a Follow-Up</strong> – Automated reminders and Smart Tasks keep you on track.</li><li><strong>Centralize Communication</strong> – Calls, emails, texts, forms, and notes in one place.</li><li><strong>Scale Your Network</strong> – AI-driven journeys nurture leads and referrals for you.</li></ul>
      <p><em>Sample Success:</em> A local realtor increased referrals by 42% in 3 months using Segwik Journeys and Smart Tasks.</p></article>`;
    } else if(name==='Segwik Pricing & Plan Snapshot'){
      html = `<article><h2>Segwik Pricing & Plan Snapshot (Quick Reference)</h2>
      <table border="1" cellpadding="8" cellspacing="0" style="border-collapse:collapse;width:100%"><thead><tr><th>Plan Name</th><th>Best For</th><th>Key Features</th><th>Price (Monthly)</th></tr></thead>
      <tbody>
        <tr><td>Core</td><td>Solo professionals just getting organized</td><td>Contact management, 2 active journeys, email/text reminders</td><td>$49</td></tr>
        <tr><td>Plus</td><td>Small businesses growing relationships</td><td>All Core features + unlimited journeys, AI follow-up, reporting dashboard</td><td>$99</td></tr>
        <tr><td>Pro</td><td>Teams & organizations with complex needs</td><td>All Plus features + multiple users, integrations, advanced automation</td><td>$199</td></tr>
      </tbody></table>
      <h3>Add-Ons:</h3>
      <ul><li><strong>Segwik Tokens:</strong> Pay-as-you-go credits for custom work, integrations, data imports.</li><li><strong>Premium Onboarding:</strong> Hands-on setup and 1-on-1 training.</li></ul></article>`;
    } else if(name==='Segwik Journeys Overview'){
      html = `<article><h2>Segwik Journeys Overview (High-Level)</h2>
      <table border="1" cellpadding="8" cellspacing="0" style="border-collapse:collapse;width:100%"><thead><tr><th>Journey Name</th><th>Purpose</th><th>Ideal Audience</th><th>Outcome</th></tr></thead>
      <tbody>
        <tr><td>New Lead Nurture</td><td>Build trust and move leads toward booking</td><td>Potential customers</td><td>Lead conversion</td></tr>
        <tr><td>Referral Partner Warm-Up</td><td>Strengthen partnerships for ongoing referrals</td><td>BNI / networking contacts</td><td>Active referral pipeline</td></tr>
        <tr><td>Post-Meeting Follow-Up</td><td>Keep momentum after a discovery call</td><td>Prospects and partners</td><td>Book next steps</td></tr>
        <tr><td>Past Client Check-In</td><td>Stay top-of-mind with previous clients</td><td>All past customers</td><td>Repeat business & referrals</td></tr>
        <tr><td>Event Attendee Journey</td><td>Engage after networking events</td><td>Attendees and connections</td><td>New leads added to CRM</td></tr>
      </tbody></table></article>`;
    } else if(name==='Segwik Packages'){
      html = `<article>
        <h2 style="margin-top:0">Segwik Onboarding Tiers & Who They’re For</h2>
        <p>Segwik offers onboarding plans tailored to different stages of business growth, from solo professionals to large organizations. Each plan is designed to match where you are now and help you grow your relationship capacity.</p>
        <h3>1. Solo / Individual</h3>
        <p><strong>Best For:</strong> Freelancers, solo creatives, independent professionals<br/>
        <strong>Plan:</strong> Momentum Starter ($199)<br/>
        <strong>Focus:</strong> Get moving quickly with essential setup, syncing, and a personalized follow-up rhythm.<br/>
        <strong>Key Features:</strong> Account configuration, contact/calendar sync, email system setup, and a 30-min jumpstart session.</p>
        <h3>2. Small Business</h3>
        <p><strong>Best For:</strong> Coaches, consultants, small business teams<br/>
        <strong>Plan:</strong> Comms + Cadence Builder ($799)<br/>
        <strong>Focus:</strong> Build professional communication systems and cadence for consistent engagement.</p>
        <p><strong>Key Features:</strong> Everything in Momentum Starter plus texting/calling setup, compliance, messaging templates, auto-attendant, and booking tools.</p>
        <h3>3. Growth-Stage Business</h3>
        <p><strong>Best For:</strong> Growth-stage pros, relationship-heavy businesses<br/>
        <strong>Plan:</strong> Intelligent Relationship Engine ($1,499)<br/>
        <strong>Focus:</strong> Scale operations with AI-driven tools and smart client engagement.</p>
        <p><strong>Key Features:</strong> Everything in Builder plus AI assistant activation, chatbot setup, contact segmentation, appointment flows, and pipeline mapping.</p>
        <h3>4. Organization / Enterprise</h3>
        <p><strong>Best For:</strong> Multi-person organizations, franchises, agencies<br/>
        <strong>Plan:</strong> Strategic Enterprise Onboarding (Custom)<br/>
        <strong>Focus:</strong> Build an advanced Relationship OS with full customization, automation, and team logic.
        <br/>
        <strong>Key Features:</strong> Everything in Engine plus workflow automation, quoting/invoicing, white-labeling, role permissions, full data migration, and a strategic roadmap session.</p>
        <h3>Add-Ons (Any Tier)</h3>
        <ul><li>Data import from older platforms</li><li>Custom nurture journey setup</li><li>Additional AI personas</li><li>Advanced integration setup</li></ul>
        <h3>Special Services</h3>
        <ul><li>Data Migration: Seamless transition from old systems</li><li>Replatforming: High-touch consulting to redesign workflows and infrastructure</li></ul>
      </article>`;
    } else {
      html = `<article><h2>${name}</h2><p>Preview unavailable. This is a placeholder for the uploaded document.</p></article>`;
    }
    createFloatWindow(name, html);
  }

  // ================= End-of-Meeting drawer (REVISED) =================
  const endBtn = document.getElementById('endBtn');
  const eomWrap = document.getElementById('eomWrap');
  const eom = document.getElementById('eom');
  const eomBody = document.getElementById('eomBody');
  const eomClose = document.getElementById('eomClose');
  const eomScrim = document.getElementById('eomScrim');
  const submitEndBtn = document.getElementById('submitEndBtn');
  const eomTabs = document.getElementById('eomTabs');
  const eomNextBtn = document.getElementById('eomNextBtn');

  const attendees = [ {id:'c1', name:'Vladimir', role:'Prospect', selected:true, journeys:[]} ];
  let meetingStatus = MEETING_STATUSES[0]; // default Attended
  let eomTab = 'summary';

  // editors + lists state
  let summaryHTML = '';
  let nextStepsHTML = '';
  let decisions = [];
  let questions = [];
  let issues = [];
  let recordings = [];     // filenames only (mock)
  let attachments = [];    // filenames only (mock)

  // Selected Smart Tasks / custom recipes reused from earlier code
  let selectedSmartTasks = [];
  const recipes = { custom:[] };
  let bulkMS = null, smartMS = null, fieldsMS = null;

  const EXISTING_JOURNEY_INFO = {
    "1-1 Request Journey": [
      {name:"Phase 1: Information Review", status:"Started"},
      {name:"Phase 2: Automated Outreach", status:"Not Begun"},
      {name:"Phase 3: Manual Follow-Up", status:"Not Begun"},
      {name:"Phase 4: No Response or Booking", status:"Not Begun"},
      {name:"Phase 5: Positive Response", status:"Not Begun"},
      {name:"Phase 6: Negative Response", status:"Not Begun"},
      {name:"Phase 7: Booking Scheduled", status:"Not Begun"},
      {name:"Phase 8: Lost User", status:"Not Begun"}
    ],
    "Met at an Event": [
      {name:"Phase 1: Capture & Tag Contact", status:"Started"},
      {name:"Phase 2: First Touch", status:"Not Begun"},
      {name:"Phase 3: Share Resources", status:"Not Begun"},
      {name:"Phase 4: Invite to Meeting", status:"Not Begun"},
      {name:"Phase 5: Nurture", status:"Not Begun"},
      {name:"Phase 6: Evaluate Interest", status:"Not Begun"},
      {name:"Phase 7: Book or Refer", status:"Not Begun"},
      {name:"Phase 8: Archive If Cold", status:"Not Begun"}
    ]
  };

  function setActiveEomTab(name){
    eomTabs.querySelectorAll('.tab').forEach(x=>{
      x.classList.toggle('active', x.dataset.tab===name);
    });
    eomTab = name;
    renderEOM();
    updateEomFooter();
  }
  function updateEomFooter(){
    const nextBtn = document.getElementById('eomNextBtn');
    const submitBtn = document.getElementById('submitEndBtn');
    if(eomTab==='summary'){ nextBtn.style.display='inline-block'; submitBtn.style.display='none'; }
    else { nextBtn.style.display='none'; submitBtn.style.display='inline-block'; }
  }

  function openEOM(){ eomWrap.classList.add('open'); setTimeout(()=> eom.classList.add('open'), 0); eomTab='summary'; renderEOM(); updateEomFooter(); }
  function closeEOM(){ eom.classList.remove('open'); setTimeout(()=> eomWrap.classList.remove('open'), 200); }
  endBtn.addEventListener('click', openEOM);
  eomClose.addEventListener('click', closeEOM);
  eomScrim.addEventListener('click', closeEOM);

  // Tabs inside drawer
  eomTabs.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', ()=> setActiveEomTab(t.dataset.tab));
  });

  // Next button -> switch to Automation and save current inputs
  eomNextBtn.addEventListener('click', ()=>{
    const sumArea = document.querySelector('#sumEd .rte-area');
    const nextArea = document.querySelector('#nextEd .rte-area');
    if(sumArea) summaryHTML = sumArea.innerHTML.trim();
    if(nextArea) nextStepsHTML = nextArea.innerHTML.trim();
    if(bulkMS) attendees[0].journeys = bulkMS.getSelected();
    if(smartMS) selectedSmartTasks = smartMS.getSelected();
    setActiveEomTab('automation');
  });

  function editorHTML(id, placeholder){
    return `
      <div class="rte" id="${id}">
        <div class="rte-toolbar">
          <button type="button" class="btn" data-cmd="bold">B</button>
          <button type="button" class="btn" data-cmd="italic"><em>I</em></button>
          <button type="button" class="btn" data-cmd="insertUnorderedList">• List</button>
          <button type="button" class="btn" data-cmd="formatBlock" data-val="h1">H1</button>
          <button type="button" class="btn" data-cmd="formatBlock" data-val="h2">H2</button>
        </div>
        <div class="rte-area" contenteditable="true" data-placeholder="${placeholder}"></div>
      </div>`;
  }
  function wireEditor(rootId, initialHTML=''){
    const root = document.getElementById(rootId);
    const area = root.querySelector('.rte-area');
    area.innerHTML = initialHTML || '';
    root.querySelectorAll('.rte-toolbar .btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const cmd = b.dataset.cmd;
        const val = b.dataset.val || null;
        if(cmd==='formatBlock'){ document.execCommand(cmd,false,val); }
        else { document.execCommand(cmd,false,null); }
      });
    });
    return { getHTML: ()=> area.innerHTML.trim() };
  }

  function listAdderHTML(key, title, placeholder){
    return `
      <div class="field list-add">
        <label>${title}</label>
        <input id="${key}Input" class="input" placeholder="${placeholder}" />
        <ul id="${key}List" class="list-items"></ul>
      </div>`;
  }
  function wireListAdder(key, store){
    const input = document.getElementById(`${key}Input`);
    const list = document.getElementById(`${key}List`);
    function render(){
      list.innerHTML = store.map((t,i)=>`<li>${t}<span data-i="${i}" class="rm">×</span></li>`).join('');
      list.querySelectorAll('.rm').forEach(x=> x.addEventListener('click', ()=>{ store.splice(parseInt(x.dataset.i),1); render(); }));
    }
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        const v = (input.value||'').trim();
        if(v){ store.push(v); input.value=''; render(); }
      }
    });
    render();
  }

  function journeyPreviewHTML(name){
    const phases = (EXISTING_JOURNEY_INFO[name]||[]);
    return `
      <div class="journey-preview" id="jp">
        ${phases.map((p,idx)=>`
          <div class="phase">
            <div class="phase-h">
              <div>${p.name}</div>
              <div class="status">Status: ${p.status} <span style="margin-left:8px">▾</span></div>
            </div>
            <div class="phase-b">Details about ${p.name} will appear here.</div>
          </div>
        `).join('')}
      </div>`;
  }
  function wireJourneyPreview(container){
    container.querySelectorAll('.phase').forEach(ph=>{
      const h = ph.querySelector('.phase-h');
      h.addEventListener('click', ()=> ph.classList.toggle('open'));
    });
  }

  function renderEOM(){
    if(eomTab==='summary'){
      eomBody.innerHTML = `
        <div class="field"><label>Set meeting status.</label>
          <div id="statusChips" style="display:flex;gap:6px;flex-wrap:wrap"></div>
        </div>
<br>
        <div class="field"><label style="font-size:18px">Summary/Takeways</label>
          ${editorHTML('sumEd','Summary/Takeways')}
        </div>
<br>
        <div class="field"><label style="font-size:18px">Next Steps</label>
          ${editorHTML('nextEd','Next Steps')}
        </div>
<br>
        ${listAdderHTML('dec','Decisions Made','Type a decision and press Enter')}
<br>
        ${listAdderHTML('uq','Unanswered Questions','Type a question and press Enter')}
<br>
        ${listAdderHTML('iss','Issues Identified','Type an issue and press Enter')}
<br>
        <div class="field"><label>Recording</label>
          <label class="upload-box" for="recUpload">Drop files here or click to upload<input id="recUpload" type="file" multiple></label>
          <div id="recFiles" class="muted" style="margin-top:6px"></div>
        </div>
<br>
        <div class="field"><label>Links & Attachments</label>
          <label class="upload-box" for="attUpload">Drop files here or click to upload<input id="attUpload" type="file" multiple></label>
          <div id="attFiles" class="muted" style="margin-top:6px"></div>
        </div>
<br>
        <div class="field">
          <label>Existing Journeys</label>
          <div class="journey-pills" id="journeyPills">
            <span class="journey-pill" data-j="1-1 Request Journey">1-1 Request Journey</span>
            <span class="journey-pill" data-j="Met at an Event">Met at an Event</span>
          </div>
          <div id="journeyInfo"></div>
        </div>
<br>
        <div class="field">
          <label>Bulk Journey</label>
          <div id="bulkMS" class="ms" data-placeholder="Pick journey(s)"></div>
        </div>
        <div class="field">
<br>
          <label>Smart Tasks</label>
          <div id="smartMS" class="ms" data-placeholder="Pick task(s)"></div>
        </div>
<br>
        <h4 style="margin-top:6px">Custom Tasks</h4>
        <div id="recipes"></div>
        <div style="margin-top:8px"><a href="#" id="addTaskLink" class="attach-link">Add a Task</a></div>
        <div id="inlineTask" style="display:none;margin-top:10px;border-top:1px solid #eef2f7;padding-top:10px">
          <div class="field"><label>Task Name</label><input id="itName" class="input" placeholder="e.g., Send welcome email"></div>
          <div class="row">
            <div class="field"><label>Task Type</label>
              <select id="itType">
                <option value="" selected disabled>Select Task Type</option>
                <option value="User">User</option>
                <option value="Contact">Contact</option>
              </select>
            </div>
            <div class="field"><label>Action</label>
              <select id="itAction">
                <option value="" selected disabled>Select Action</option>
                <option value="Send Email">Send Email</option>
                <option value="Send Text">Send Text</option>
                <option value="Fill in Contact Fields">Fill in Contact Fields</option>
              </select>
            </div>
          </div>
          <div id="actionExtras"></div>
          <div class="field"><label>Short Description</label><input id="itShort" class="input" placeholder="Short description"></div>
          <div class="field"><label>Long Description</label><textarea id="itLong" class="input" placeholder="Details..."></textarea></div>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="btn" id="itCancel">Cancel</button>
            <button class="btn primary" id="itAdd">Add Task</button>
          </div>
        </div>
      `;

      // Status chips
      const chips = document.getElementById('statusChips');
      MEETING_STATUSES.forEach(st=>{
        const span = document.createElement('span');
        span.className = 'chip'+(st===meetingStatus?' selected':'');
        span.textContent = st;
        span.addEventListener('click', ()=>{ meetingStatus = st; renderEOM(); });
        chips.appendChild(span);
      });

      // editors
      const sumEd = wireEditor('sumEd', summaryHTML);
      const nextEd = wireEditor('nextEd', nextStepsHTML);

      // list adders
      wireListAdder('dec', decisions);
      wireListAdder('uq', questions);
      wireListAdder('iss', issues);

      // uploads
      const recUp = document.getElementById('recUpload');
      const attUp = document.getElementById('attUpload');
      const recFiles = document.getElementById('recFiles');
      const attFiles = document.getElementById('attFiles');
      function renderFiles(){
        recFiles.textContent = recordings.length ? recordings.join(', ') : 'No files added';
        attFiles.textContent = attachments.length ? attachments.join(', ') : 'No files added';
      }
      function bindUpload(input, store, cb){
        input.addEventListener('change', ()=>{ Array.from(input.files||[]).forEach(f=>store.push(f.name)); input.value=''; cb(); });
        const box = input.closest('.upload-box');
        box.addEventListener('dragover', e=>{ e.preventDefault(); box.style.background='#f1f7ff'; });
        box.addEventListener('dragleave', ()=>{ box.style.background=''; });
        box.addEventListener('drop', e=>{ e.preventDefault(); box.style.background=''; Array.from(e.dataTransfer.files||[]).forEach(f=>store.push(f.name)); cb(); });
      }
      bindUpload(recUp, recordings, renderFiles);
      bindUpload(attUp, attachments, renderFiles);
      renderFiles();

      // Existing Journeys preview
      const jpills = document.getElementById('journeyPills');
      const jinfo = document.getElementById('journeyInfo');
      jpills.querySelectorAll('.journey-pill').forEach(p=>{
        p.addEventListener('click', ()=>{
          jpills.querySelectorAll('.journey-pill').forEach(x=>x.classList.remove('active'));
          p.classList.add('active');
          jinfo.innerHTML = journeyPreviewHTML(p.dataset.j);
          wireJourneyPreview(jinfo);
        });
      });

      // Tag-style controls
      bulkMS = createTagMultiSelect(document.getElementById('bulkMS'), JOURNEYS, new Set(attendees[0].journeys));
      smartMS = createTagMultiSelect(document.getElementById('smartMS'), SMART_TASK_OPTIONS, new Set(selectedSmartTasks));

      // Render existing custom tasks
      const recWrap = document.getElementById('recipes'); recWrap.innerHTML='';
      recipes.custom.forEach((t,i)=> recWrap.appendChild(customToggle(t,i)) );

      // Inline custom task adder
      const addTaskLink = document.getElementById('addTaskLink');
      const inlineTask = document.getElementById('inlineTask');
      const actionExtras = document.getElementById('actionExtras');
      addTaskLink.addEventListener('click', (e)=>{ e.preventDefault(); inlineTask.style.display = inlineTask.style.display==='none' ? 'block' : 'none'; });
      document.getElementById('itCancel').addEventListener('click', ()=> inlineTask.style.display='none');
      const itAction = document.getElementById('itAction');
      function renderActionExtras(){
        const val = itAction.value;
        let html = '';
        if(val==='Send Email'){
          html = `<div class="field"><label>Select Email</label>
            <select id="itEmail">
              <option value="" selected disabled>Select Email</option>
              <option>General Post-Meeting Thank You Email</option>
              <option>Post-Meeting Follow-Up Email</option>
              <option>Missed Meeting Follow-Up Email</option>
            </select>
          </div>`;
          fieldsMS = null;
        } else if(val==='Send Text'){
          html = `<div class="field"><label>Select Text</label>
            <select id="itText">
              <option value="" selected disabled>Select Text</option>
              <option>General Post-Meeting Thank You Text</option>
              <option>Post-Meeting Follow-Up Text</option>
              <option>Missed Meeting Follow-Up Text</option>
            </select>
          </div>`;
          fieldsMS = null;
        } else if(val==='Fill in Contact Fields'){
          html = `<div class="field"><label>Select Contact Fields</label>
            <div id="itFieldsMS" class="ms" data-placeholder="Select Contact Fields"></div>
          </div>`;
        } else {
          html = '';
          fieldsMS = null;
        }
        actionExtras.innerHTML = html;
        if(val==='Fill in Contact Fields'){
          fieldsMS = createTagMultiSelect(document.getElementById('itFieldsMS'), CONTACT_FIELD_OPTIONS, new Set());
        }
      }
      itAction.addEventListener('change', renderActionExtras);

      document.getElementById('itAdd').addEventListener('click', ()=>{
        const name = (document.getElementById('itName').value||'').trim();
        const type = document.getElementById('itType').value || '';
        const action = document.getElementById('itAction').value || '';
        const shortD = (document.getElementById('itShort').value||'').trim();
        const longD = (document.getElementById('itLong').value||'').trim();
        if(!name){ alert('Please enter Task Name.'); return; }
        if(!type){ alert('Please select Task Type.'); return; }
        if(!action){ alert('Please select Action.'); return; }
        let extra = '';
        if(action==='Send Email'){
          const emSel = document.getElementById('itEmail'); const em = emSel ? (emSel.value || '') : '';
          if(!em){ alert('Please select an Email template.'); return; }
          extra = ` • Template: ${em}`;
        } else if(action==='Send Text'){
          const txSel = document.getElementById('itText'); const tx = txSel ? (txSel.value || '') : '';
          if(!tx){ alert('Please select a Text template.'); return; }
          extra = ` • Template: ${tx}`;
        } else if(action==='Fill in Contact Fields'){
          const fields = fieldsMS ? fieldsMS.getSelected() : [];
          if(!fields.length){ alert('Please select at least one Contact Field.'); return; }
          extra = ` • Fields: ${fields.join(', ')}`;
        }
        const desc = `[${type}] • ${action}${extra}${shortD?(' • '+shortD):''}${longD?(' — '+longD):''}`;
        recipes.custom.push({title:name, desc, enabled:true});
        renderEOM(); // re-render to show new row
      });

      // Save editors on input
      const saveEditors = ()=>{ summaryHTML = sumEd.getHTML(); nextStepsHTML = nextEd.getHTML(); };
      eomBody.addEventListener('input', (e)=>{ if(e.target.closest('#sumEd')||e.target.closest('#nextEd')) saveEditors(); });
      eomBody.addEventListener('blur', saveEditors, true);

    } else {
      // AUTOMATION preview
      const journeys = (attendees[0].journeys||[]).join(', ') || 'None';
      const enabledTasks = [...selectedSmartTasks];
      recipes.custom.forEach(t=>{ if(t.enabled) enabledTasks.push(`Custom: ${t.title}`); });

      eomBody.innerHTML = `
        <div class="card" style="border:1px solid #eef2f7;border-radius:12px;padding:12px">
          <h4 style="margin:6px 0 8px">Automation Preview</h4>
          <div class="fus-row"><div class="muted">Contact</div><div>Vladimir</div></div>
          <div class="fus-row"><div class="muted">Meeting Status</div><div><span class="chip selected">${meetingStatus}</span></div></div>
          <div class="fus-row"><div class="muted">Journeys</div><div>${journeys}</div></div>
          <div class="fus-row"><div class="muted">Smart & Custom Tasks</div><div>${enabledTasks.length?('<ul class="fus-list">'+enabledTasks.map(t=>`<li>${t}</li>`).join('')+'</ul>'):'None'}</div></div>
          <hr style="border:none;border-top:1px solid #eef2f7;margin:10px 0">
          <div class="fus-row"><div class="muted">Summary/Takeways</div><div>${summaryHTML || '<span class="muted">—</span>'}</div></div>
          <div class="fus-row"><div class="muted">Next Steps</div><div>${nextStepsHTML || '<span class="muted">—</span>'}</div></div>
          <div class="fus-row"><div class="muted">Decisions</div><div>${decisions.length?('<ul class="fus-list">'+decisions.map(x=>`<li>${x}</li>`).join('')+'</ul>'):'—'}</div></div>
          <div class="fus-row"><div class="muted">Unanswered Qs</div><div>${questions.length?('<ul class="fus-list">'+questions.map(x=>`<li>${x}</li>`).join('')+'</ul>'):'—'}</div></div>
          <div class="fus-row"><div class="muted">Issues</div><div>${issues.length?('<ul class="fus-list">'+issues.map(x=>`<li>${x}</li>`).join('')+'</ul>'):'—'}</div></div>
          <div class="fus-row"><div class="muted">Recording</div><div>${recordings.length? recordings.join(', ') : '—'}</div></div>
          <div class="fus-row"><div class="muted">Links & Attachments</div><div>${attachments.length? attachments.join(', ') : '—'}</div></div>
        </div>
      `;
    }
  }

  // render custom toggle row
  function customToggle(task, idx){
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #eef2f7';
    row.innerHTML=`<input type="checkbox" ${task.enabled?'checked':''} data-i="${idx}"> <strong>${task.title}</strong> <span class="muted">${task.desc||''}</span>`;
    const box=row.querySelector('input');
    box.addEventListener('change', ()=> { task.enabled = box.checked; updateCounter(); });
    return row;
  }

  function updateCounter(){
    const rc = selectedSmartTasks.length + (recipes.custom.filter(t=>t.enabled).length);
    const ctr = document.getElementById('eomCounter'); // may not exist now
    if(ctr){ ctr.textContent = `1 selected • ${rc} task${rc===1?'':'s'}`; }
  }

  // --- NEW: Follow-Up Summary rendering & controls ---
  const followUpCard = document.getElementById('followUpCard');
  function renderFollowUpSummary(){
    document.getElementById('fuContact').textContent = attendees[0].name || 'Contact';
    document.getElementById('fuStatus').textContent = meetingStatus;

    const body = followUpCard.querySelector('.fus-body');
    function ensureSection(id, title){
      let sec = document.getElementById(id);
      if(!sec){
        sec = document.createElement('div');
        sec.className = 'fus-section';
        sec.id = id;
        sec.innerHTML = `<h4>${title}</h4><div class="content"></div>`;
        body.appendChild(sec);
      }
      return sec.querySelector('.content');
    }
    const sumC = ensureSection('fusSum','Summary/Takeways'); sumC.innerHTML = summaryHTML || '<span class="muted">—</span>';
    const nextC = ensureSection('fusNext','Next Steps'); nextC.innerHTML = nextStepsHTML || '<span class="muted">—</span>';
    const decC = ensureSection('fusDec','Decisions Made'); decC.innerHTML = decisions.length?('<ul class="fus-list">'+decisions.map(x=>`<li>${x}</li>`).join('')+'</ul>'):'—';
    const qC = ensureSection('fusQ','Unanswered Questions'); qC.innerHTML = questions.length?('<ul class="fus-list">'+questions.map(x=>`<li>${x}</li>`).join('')+'</ul>'):'—';
    const issC = ensureSection('fusIss','Issues Identified'); issC.innerHTML = issues.length?('<ul class="fus-list">'+issues.map(x=>`<li>${x}</li>`).join('')+'</ul>'):'—';
    const recC = ensureSection('fusRec','Recording'); recC.textContent = recordings.length? recordings.join(', ') : '—';
    const attC = ensureSection('fusAtt','Links & Attachments'); attC.textContent = attachments.length? attachments.join(', ') : '—';

    const jWrap = document.getElementById('fuJourneys'); jWrap.innerHTML = '';
    const jList = (attendees[0].journeys && attendees[0].journeys.length) ? attendees[0].journeys : ['None'];
    jList.forEach(j=>{ const span = document.createElement('span'); span.className = 'pill'; span.textContent = j; jWrap.appendChild(span); });

    const tWrap = document.getElementById('fuTasks'); tWrap.innerHTML = '';
    const tasks = [...selectedSmartTasks]; recipes.custom.forEach(t=>{ if(t.enabled) tasks.push(`Custom: ${t.title}`); });
    if(tasks.length===0){ const li = document.createElement('li'); li.textContent = 'None'; tWrap.appendChild(li); }
    else { tasks.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; tWrap.appendChild(li); }); }

    document.getElementById('fuQueuedTime').textContent = 'Just now';
    document.getElementById('fuApplies').textContent = attendees[0].name || 'Contact';
  }

  function showPostMeetingUI(){
    endBtn.classList.add('disabled');
    endBtn.setAttribute('disabled', 'true');
    document.getElementById('followUpHead').style.display = 'flex';
    followUpCard.style.display = 'block';
    renderFollowUpSummary();
  }

  function runSmartTasks(){
    if(bulkMS){ attendees[0].journeys = bulkMS.getSelected(); }
    if(smartMS){ selectedSmartTasks = smartMS.getSelected(); }

    const payload = { meeting_id:'mtg_demo', meeting_status: meetingStatus, recipes: [] };
    const contactId = attendees[0].id;

    if(attendees[0].journeys && attendees[0].journeys.length){
      payload.recipes.push({ type:'assign_to_journeys', contacts: [{ contact_id: contactId, journeys: attendees[0].journeys }] });
    }

    selectedSmartTasks.forEach(t=>{
      if(t==='Modify Contact Details'){
        payload.recipes.push({ type:'modify_contact_details', contacts:[contactId], attributes:{} });
      } else if(t==='Forward Contact To Pete for Follow-Up'){
        payload.recipes.push({ type:'forward_to_pete_follow_up', contacts:[contactId] });
      } else if(t==='Create a Project'){
        payload.recipes.push({ type:'create_project', contacts:[contactId], project_name:'From Meeting' });
      } else if(t==='Log Note'){
        payload.recipes.push({ type:'log_note', contacts:[contactId], note:'From End-of-Meeting' });
      }
    });

    payload.summary = {
      meeting_status: meetingStatus,
      summary_html: summaryHTML,
      next_steps_html: nextStepsHTML,
      decisions, questions, issues,
      recordings, attachments
    };

    console.log('SMART TASKS PAYLOAD', payload);

    showPostMeetingUI();
    closeEOM();
    alert('Smart Tasks queued and meeting ended!');
  }

  submitEndBtn.addEventListener('click', runSmartTasks);

  /* ===== Attendee Tasks logic (scoped) ===== */
  const tasks = {
    pre: [
      { id: 'p1', title: 'Fill Out Form', type: 'Contact', action: 'Fill Out Form', resource: 'Segwik Initial Walkthrough Form', status: 'Assigned' },
      { id: 'p2', title: 'Watch Video', type: 'Contact', action: 'Watch Video', resource: 'Segwik App Intro Video', status: 'Assigned' }
    ],
    post: [
      { id: 'q1', title: 'Fill Out Form', type: 'Contact', action: 'Fill Out Form', resource: 'Post-Meeting Feedback Form', status: 'Assigned' }
    ]
  };
  const STATUS_OPTS = ['Started','Assigned','Completed','Queued','Cancelled','Paused'];
  const preList = document.getElementById('preList');
  const postList = document.getElementById('postList');

  // Tabs for Attendee Tasks only
  document.querySelectorAll('#attTabs .tab').forEach(t=>t.addEventListener('click',()=>{
    document.querySelectorAll('#attTabs .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const isPre = t.dataset.tab==='pre';
    document.getElementById('prePanel').style.display = isPre?'block':'none';
    document.getElementById('postPanel').style.display = isPre?'none':'block';
  }));

  function renderAttendeeTasks(){
    preList.innerHTML = '';
    postList.innerHTML = '';
    tasks.pre.forEach(t => preList.appendChild(taskRow(t, 'pre')));
    tasks.post.forEach(t => postList.appendChild(taskRow(t, 'post')));
  }

  function taskRow(t, bucket){
    const row = document.createElement('div');
    row.className = 'task-item';

    const left = document.createElement('div');
    left.innerHTML = `<div class="task-title">${t.title}</div>` +
      `<div class="task-meta">`+
      (t.action==='Fill Out Form' ? `Form: <strong>${t.resource||''}</strong>` :
       t.action==='Watch Video' ? `Video: <strong>${t.resource||''}</strong>` :
       t.action==='Read Article' ? `Article: <strong>${t.resource||''}</strong>` :
       `Action: <strong>${t.action}</strong>`) +
      `</div>`;

    const right = document.createElement('div');
    right.className = 'task-actions';

    const openBtn = document.createElement('button');
    openBtn.className = 'btn';
    openBtn.textContent = t.action==='Fill Out Form' ? 'Open Form' : (t.action==='Watch Video' ? 'Open Video' : 'Open');
    openBtn.addEventListener('click', ()=>{
      if(t.action === 'Fill Out Form'){
        openFormWindow(t.resource || t.title);
      } else if(t.action === 'Watch Video'){
        openVideoWindow(t.resource || t.title);
      } else {
        alert(`${openBtn.textContent}: ${t.resource||t.title}`);
      }
    });

    const statusChip = document.createElement('span');
    statusChip.className = 'chip';
    statusChip.textContent = t.status || 'Assigned';

    const menu = document.createElement('div');
    menu.className = 'menu';
    const kebab = document.createElement('button');
    kebab.className = 'kebab';
    kebab.innerHTML = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#0F2D56" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/></svg>';
    const fly = document.createElement('div');
    fly.className = 'menu-flyout';

    STATUS_OPTS.forEach(st => {
      const mi = document.createElement('div');
      mi.className = 'menu-item';
      mi.innerHTML = `<span>${st === 'Assigned' ? 'Assign Task' : st === 'Started' ? 'Start Task' : st}</span>`;
      mi.addEventListener('click', ()=>{ t.status = st; statusChip.textContent = st; menu.classList.remove('open'); });
      fly.appendChild(mi);
    });

    const sep = document.createElement('div'); sep.style.cssText='height:1px;background:#f2f5fa;margin:4px 0'; fly.appendChild(sep);

    const del = document.createElement('div');
    del.className = 'menu-item';
    del.innerHTML = '<span>Remove Task</span>';
    del.addEventListener('click', ()=> openRemove(()=>{
      const list = tasks[bucket];
      const idx = list.findIndex(x=>x.id===t.id);
      if(idx>-1){ list.splice(idx,1); renderAttendeeTasks(); }
    }));
    fly.appendChild(del);

    menu.appendChild(kebab); menu.appendChild(fly);
    kebab.addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('open'); });
    document.addEventListener('click', ()=> menu.classList.remove('open'));

    right.appendChild(openBtn);
    right.appendChild(statusChip);
    right.appendChild(menu);

    row.appendChild(left);
    row.appendChild(right);
    return row;
  }

  // Add Task modal logic
  const taskModal = document.getElementById('taskModal');
  const taskClose = document.getElementById('taskClose');
  const taskCancel = document.getElementById('taskCancel');
  const taskSave = document.getElementById('taskSave');
  const tAction = document.getElementById('tAction');
  const tExtras = document.getElementById('tExtras');
  let fieldsMS_Att = null; // tag-style multi-select instance for contact fields

  function openTaskModal(){ taskModal.classList.add('open'); renderExtras(); }
  function closeTaskModal(){ taskModal.classList.remove('open'); clearTaskForm(); }

  document.getElementById('addTaskBtn').addEventListener('click', openTaskModal);
  taskClose.addEventListener('click', closeTaskModal);
  taskCancel.addEventListener('click', closeTaskModal);

  tAction.addEventListener('change', renderExtras);

  function renderExtras(){
    const val = tAction.value;
    let html = '';
    fieldsMS_Att = null;

    if(val==='Send Email'){
      html = `<div class="field"><label>Select Email</label>
        <select id="tEmail">
          <option value="" selected disabled>Select Email</option>
          <option>General Post-Meeting Thank You Email</option>
          <option>Post-Meeting Follow-Up Email</option>
          <option>Missed Meeting Follow-Up Email</option>
        </select>
      </div>`;
    } else if(val==='Send Text'){
      html = `<div class="field"><label>Select Text</label>
        <select id="tText">
          <option value="" selected disabled>Select Text</option>
          <option>General Post-Meeting Thank You Text</option>
          <option>Post-Meeting Follow-Up Text</option>
          <option>Missed Meeting Follow-Up Text</option>
        </select>
      </div>`;
    } else if(val==='Fill in Contact Fields'){
      html = `<div class="field"><label>Select Contact Fields</label>
        <div id="tFieldsMS" class="ms" data-placeholder="Select Contact Fields"></div>
      </div>`;
    } else if(val==='Fill Out Form'){
      html = `<div class="field"><label>Select Form</label>
        <select id="tForm">
          <option value="" disabled selected>Select Form</option>
          <option>Segwik Initial Walkthrough Form</option>
          <option>Post-Meeting Feedback Form</option>
          <option>Discovery Questionnaire</option>
          <option>Onboarding Checklist</option>
        </select>
      </div>`;
    } else if(val==='Watch Video'){
      html = `<div class="field"><label>Select Video</label>
        <select id="tVideo">
          <option value="" disabled selected>Select Video</option>
          <option>Segwik App Intro Video</option>
        </select>
      </div>`;
    } else if(val==='Read Article'){
      html = `<div class="field"><label>Select Article</label>
        <select id="tArticle">
          <option value="" disabled selected>Select Article</option>
          <option>Segwik Quick Pitch Guide</option>
          <option>Segwik Journeys Overview</option>
        </select>
      </div>`;
    }
    tExtras.innerHTML = html;

    if(val==='Fill in Contact Fields'){
      fieldsMS_Att = createTagMultiSelect(document.getElementById('tFieldsMS'), CONTACT_FIELD_OPTIONS, new Set());
    }
  }

  function clearTaskForm(){
    document.getElementById('tName').value = '';
    document.getElementById('tType').selectedIndex = 0;
    document.getElementById('tAction').selectedIndex = 0;
    document.getElementById('tShort').value = '';
    document.getElementById('tLong').value = '';
    tExtras.innerHTML = '';
    fieldsMS_Att = null;
  }

  taskSave.addEventListener('click', ()=>{
    const name = (document.getElementById('tName').value||'').trim();
    const type = document.getElementById('tType').value || '';
    const action = document.getElementById('tAction').value || '';
    const isPreActive = document.querySelector('#attTabs .tab.active')?.dataset.tab === 'pre';

    if(!name){ alert('Please enter Task Name.'); return; }
    if(!type){ alert('Please select Task Type.'); return; }
    if(!action){ alert('Please select Action.'); return; }

    let resource = '';
    if(action==='Fill Out Form'){ resource = document.getElementById('tForm')?.value || ''; if(!resource){ alert('Please select a Form.'); return; } }
    if(action==='Watch Video'){ resource = document.getElementById('tVideo')?.value || ''; if(!resource){ alert('Please select a Video.'); return; } }
    if(action==='Read Article'){ resource = document.getElementById('tArticle')?.value || ''; if(!resource){ alert('Please select an Article.'); return; } }
    if(action==='Fill in Contact Fields'){
      const sel = fieldsMS_Att ? fieldsMS_Att.getSelected() : [];
      if(!sel.length){ alert('Please select at least one Contact Field.'); return; }
      resource = sel.join(', ');
    }

    const id = Math.random().toString(36).slice(2,9);
    const newTask = { id, title: name, type, action, resource, status: 'Assigned' };
    (isPreActive ? tasks.pre : tasks.post).push(newTask);
    renderAttendeeTasks();
    closeTaskModal();
  });

  // Remove confirm for Attendee Tasks
  const rem = document.getElementById('removeConfirm');
  const remYes = document.getElementById('remYes');
  const remNo = document.getElementById('remNo');
  const remClose = document.getElementById('remClose');
  let removeFn = null;
  function openRemove(onYes){ removeFn = onYes; rem.classList.add('open'); }
  [remNo, remClose].forEach(b=> b.addEventListener('click', ()=>{ rem.classList.remove('open'); removeFn=null; }));
  remYes.addEventListener('click', ()=>{ if(removeFn) removeFn(); rem.classList.remove('open'); removeFn=null; });

  // Dragging for Add Task modal
  (function(){
    const dialog = document.getElementById('taskDialog');
    const bar = dialog.querySelector('.dragbar');
    let sx, sy, sl, st, dragging=false;
    bar.addEventListener('mousedown', (e)=>{ dragging=true; const r=dialog.getBoundingClientRect(); sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top; document.body.style.userSelect='none'; });
    window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; dialog.style.left=(sl+dx)+'px'; dialog.style.top=(st+dy)+'px'; dialog.style.position='fixed'; });
    window.addEventListener('mouseup', ()=>{ dragging=false; document.body.style.userSelect=''; });
  })();

  // Init renders
  renderAll();
  renderAttendeeTasks();
</script>
</body>
</html>



